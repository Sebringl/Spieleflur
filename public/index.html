<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Schocken Multiplayer</title>
  <link rel="icon" href="/icon.png" sizes="1024x1024" type="image/png" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html { font-size: 18px; }
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; max-width: 760px; margin: auto; transition: background-color 0.2s ease; }
    .dice-container { display: flex; justify-content: center; gap: 14px; margin: 16px 0; }
    .die { font-size: 140px; line-height: 140px; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px; user-select: none; }
    .held { border-color: green; background-color: #eaffea; }
    button { padding: 12px; width: min(320px, 90%); height: 62px; font-size: 20px; margin: 8px; }
    input { font-size: 18px; padding: 10px; margin: 6px; width: min(320px, 90%); }
    #result, #throwCount, #playerDisplay { font-size: 18px; margin-top: 10px; transition: color 0.2s ease; }
    #historyTable table { border-collapse: collapse; margin: auto; width: 100%; font-size: 0.9rem; }
    #historyTable th, #historyTable td { border: 1px solid #ccc; padding: 4px 6px; text-align: center; background-color: white; }
    #historyTable th { background-color: #e0e0e0; font-weight: bold; }
    .winner { background-color: #fff9c4; }
    #lobbyCard { border: 1px solid #ddd; border-radius: 12px; padding: 16px; text-align: left; }
    .small { font-size: 14px; opacity: 0.85; }
    .codeBig { font-size: 32px; letter-spacing: 3px; font-weight: 800; text-align: center; margin: 10px 0; }
    .playerList { text-align: left; max-width: 420px; margin: 0 auto; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid #ddd; font-size: 13px; margin-left: 8px; }
    .ok { background: #eaffea; }
    .bad { background: #ffe5e5; }
    .toggle-row { display: flex; align-items: center; gap: 10px; margin: 8px 0; padding: 10px 12px; border: 1px solid #eee; border-radius: 10px; background: #fafafa; }
    .toggle-row input[type="checkbox"] { width: 18px; height: 18px; margin: 0; }
    .code-input-row { display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; }
    .code-input-row input { flex: 1 1 220px; margin: 6px 0; }
    .icon-btn { width: 46px; height: 46px; border-radius: 10px; font-size: 20px; padding: 0; margin: 6px 0; }
    .icon-btn span { display: inline-block; transform: rotate(0deg); }
    .lobby-list { text-align: left; max-width: 420px; margin: 10px auto; }
    .lobby-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px solid #eee; border-radius: 10px; padding: 10px; margin: 8px 0; }
    .lobby-item button { width: auto; min-width: 140px; height: 44px; font-size: 16px; margin: 0; }
    .muted { opacity: 0.7; }
    .header-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .header-row button { width: auto; height: 40px; font-size: 16px; margin: 0; }
    footer { margin-top: 24px; font-size: 14px; color: #555; }
    .impressum-link { display: inline-block; margin-top: 20px; font-size: 14px; color: #555; }
  </style>
</head>
<body>
  <h1>Schocken (Multiplayer)</h1>

  <div id="lobby">
    <div id="lobbyCard">
      <div class="header-row">
        <h2>Lobby</h2>
        <button id="btnReload">Reload</button>
      </div>

      <hr />
      <div id="rejoinBox" style="display:none;">
        <h3>Wieder beitreten</h3>
        <div class="small">Wir haben ein gespeichertes Room-Login gefunden.</div>
        <button id="btnRejoin">Wieder beitreten</button>
        <button id="btnForget">Vergessen</button>
      </div>

      <hr />
      <h3>Spiel beitreten</h3>
      <div class="small">Der Host muss den Beitritt best√§tigen.</div>
      <input id="joinName" type="text" placeholder="Dein Name" />
      <input id="joinCode" type="text" placeholder="Room-Code (z.B. K7F3Q9)" />
      <button id="btnJoin">Beitritt anfragen</button>
      <div id="joinStatus" class="small muted"></div>

      <div class="lobby-list" id="activeLobbies">
        <div class="small muted">Aktive Lobbys werden geladen‚Ä¶</div>
      </div>

      <hr />
      <h3>Neues Spiel erstellen (Host)</h3>
      <input id="hostName" type="text" placeholder="Dein Name" />
      <div class="code-input-row">
        <input id="hostCode" type="text" placeholder="Room-Code (z.B. K7F3Q9)" />
        <button id="btnNewCode" class="icon-btn" title="Neuen Code erzeugen" aria-label="Neuen Code erzeugen">
          <span>üîÑ</span>
        </button>
      </div>
      <label class="toggle-row">
        <input type="checkbox" id="deckelToggle" />
        <span>Mit Deckeln spielen</span>
      </label>
      <button id="btnCreate">Neues Spiel erstellen</button>

      <hr />
      <div id="roomView" style="display:none;">
        <h3>Room</h3>
        <div class="codeBig" id="roomCodeBig">------</div>
        <div class="playerList" id="playerList"></div>
        <div class="playerList" id="pendingList"></div>
        <div id="hostControls" style="display:none; margin-top: 10px;">
          <button id="btnStartGame">Spiel starten</button>
        </div>
        <div class="small" id="hostStartHint">Nur der Host kann das Spiel starten.</div>
      </div>

      <div id="lobbyError" style="color:red; margin-top: 10px;"></div>
    </div>
  </div>

  <div id="game" style="display:none;">
    <div class="turn-row">
      <h2 id="playerDisplay">Am Zug: -</h2>
      <button id="btnRotatePlayer" class="icon-btn" title="N√§chster Spieler" aria-label="N√§chster Spieler">‚ü≥</button>
    </div>
    <div class="small" id="turnHint"></div>

    <div class="dice-container">
      <div class="die" id="die0">‚ñ°</div>
      <div class="die" id="die1">‚ñ°</div>
      <div class="die" id="die2">‚ñ°</div>
    </div>

    <button id="rollBtn">W√ºrfeln</button>
    <button id="endTurnBtn">Zug beenden</button>

    <div id="throwCount">Wurf: 0</div>
    <div id="roundDisplay" style="margin-top:10px; font-weight:bold;">Runde: 1</div>
    <div id="result"></div>
    <div id="historyTable" style="margin-top: 14px;"></div>

    <div style="margin-top: 14px;">
      <button id="btnBackToLobby">Zur√ºck zur Lobby</button>
    </div>
  </div>

  <footer>
    <a class="impressum-link" href="/impressum.html" target="_blank" rel="noopener noreferrer">Impressum</a>
  </footer>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const diceSymbols = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
    const playerTextColors = ['#e6194b','#4363d8','#f58231','#911eb4','#008080','#f032e6','#bcf60c','#0082c8'];
    const playerBgColors   = ['#ffe5e5','#e5e5ff','#fff5e5','#f5e5ff','#e5f5ff','#ffe5f5','#f5ffe5','#e5ffff'];

    let myToken    = localStorage.getItem("schocken_token") || null;
    let myRoomCode = localStorage.getItem("schocken_code") || null;
    let mySeat     = Number(localStorage.getItem("schocken_seat") || "-1");
    let myName     = localStorage.getItem("schocken_name") || "";
    let isHost     = false;
    let wasMyTurn  = false;
    let joinPending = null;

    let room = null;
    let state = null;

    function setView(view) {
      document.getElementById("lobby").style.display = (view === "lobby") ? "block" : "none";
      document.getElementById("game").style.display  = (view === "game") ? "block" : "none";
    }
    function showLobbyError(msg) {
      document.getElementById("lobbyError").textContent = msg || "";
    }
    function showJoinStatus(msg) {
      document.getElementById("joinStatus").textContent = msg || "";
    }
    function showGameMessage(msg, isError=false) {
      const el = document.getElementById("result");
      el.textContent = msg || "";
      el.style.color = isError ? "red" : "black";
    }
    function makeCode(len = 6) {
      const alphabet = "23456789ABCDEFGHJKMNPQRSTUVWXYZ";
      let s = "";
      for (let i = 0; i < len; i++) s += alphabet[Math.floor(Math.random() * alphabet.length)];
      return s;
    }
    function setSuggestedCode() {
      document.getElementById("hostCode").value = makeCode();
    }
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function isMyTurn() {
      return state && mySeat >= 0 && state.currentPlayer === mySeat;
    }

    async function notifyMyTurn(playerName) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "denied") return;

      if (Notification.permission === "default") {
        try {
          const permission = await Notification.requestPermission();
          if (permission !== "granted") return;
        } catch (err) {
          return;
        }
      }

      const title = "Du bist am Zug";
      const body = playerName ? `Am Zug: ${playerName}` : "Jetzt bist du dran!";

      if ("serviceWorker" in navigator) {
        try {
          const reg = await navigator.serviceWorker.ready;
          await reg.showNotification(title, {
            body,
            icon: "/icon.png",
            badge: "/icon.png"
          });
          return;
        } catch (err) {
          // fall back to window notification
        }
      }

      try {
        new Notification(title, { body });
      } catch (err) {
        // ignore
      }
    }

    async function notifyJoinRequest(playerName, code) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "denied") return;

      if (Notification.permission === "default") {
        try {
          const permission = await Notification.requestPermission();
          if (permission !== "granted") return;
        } catch (err) {
          return;
        }
      }

      const title = "Beitrittsanfrage";
      const body = `${playerName} m√∂chte Lobby ${code} beitreten.`;

      if ("serviceWorker" in navigator) {
        try {
          const reg = await navigator.serviceWorker.ready;
          await reg.showNotification(title, {
            body,
            icon: "/icon.png",
            badge: "/icon.png"
          });
          return;
        } catch (err) {
          // fall back to window notification
        }
      }

      try {
        new Notification(title, { body });
      } catch (err) {
        // ignore
      }
    }

    function renderRoomView() {
      if (!room) return;
      document.getElementById("roomView").style.display = "block";
      document.getElementById("roomCodeBig").textContent = room.code;

      const list = room.players || [];
      let html = "<h4>Spieler</h4><ul>";
      list.forEach(p => {
        const connected = p.connected ? `<span class="pill ok">online</span>` : `<span class="pill bad">offline</span>`;
        html += `<li>${escapeHtml(p.name)} ${connected}</li>`;
      });
      html += "</ul>";
      document.getElementById("playerList").innerHTML = html;

      document.getElementById("hostControls").style.display = isHost ? "block" : "none";
      const hint = document.getElementById("hostStartHint");
      if (hint) {
        hint.textContent = isHost ? "Nur du kannst das Spiel starten." : "Nur der Host kann das Spiel starten.";
      }
      renderPendingList([]);
    }

    function renderPendingList(requests) {
      const container = document.getElementById("pendingList");
      if (!isHost) {
        container.innerHTML = "";
        return;
      }
      if (!requests || requests.length === 0) {
        container.innerHTML = "<h4>Beitrittsanfragen</h4><div class='small muted'>Keine offenen Anfragen.</div>";
        return;
      }
      let html = "<h4>Beitrittsanfragen</h4><ul>";
      requests.forEach(req => {
        const safeName = escapeHtml(req.name);
        html += `<li>${safeName}
          <button class="icon-btn" data-approve="${req.id}" title="Annehmen">‚úÖ</button>
          <button class="icon-btn" data-deny="${req.id}" title="Ablehnen">‚ùå</button>
        </li>`;
      });
      html += "</ul>";
      container.innerHTML = html;

      container.querySelectorAll("button[data-approve]").forEach(btn => {
        btn.onclick = () => {
          if (!room || !myToken) return;
          socket.emit("approve_join", { code: room.code, token: myToken, requestId: btn.dataset.approve, accept: true });
        };
      });
      container.querySelectorAll("button[data-deny]").forEach(btn => {
        btn.onclick = () => {
          if (!room || !myToken) return;
          socket.emit("approve_join", { code: room.code, token: myToken, requestId: btn.dataset.deny, accept: false });
        };
      });
    }

    function renderLobbyList(lobbies) {
      const container = document.getElementById("activeLobbies");
      if (!lobbies || lobbies.length === 0) {
        container.innerHTML = "<div class='small muted'>Keine aktiven Lobbys gefunden.</div>";
        return;
      }
      let html = "<h4>Aktive Lobbys</h4>";
      lobbies.forEach(lobby => {
        const host = escapeHtml(lobby.hostName || "Host");
        html += `<div class="lobby-item">
          <div>
            <div><strong>${lobby.code}</strong> ¬∑ ${host}</div>
            <div class="small muted">${lobby.playerCount} Spieler ¬∑ ${lobby.useDeckel ? "mit Deckeln" : "ohne Deckel"}</div>
          </div>
          <button data-join="${lobby.code}">Beitreten</button>
        </div>`;
      });
      container.innerHTML = html;
      container.querySelectorAll("button[data-join]").forEach(btn => {
        btn.onclick = () => {
          const name = document.getElementById("joinName").value.trim();
          const code = btn.dataset.join;
          if (!name) return showLobbyError("Bitte Name eingeben.");
          showLobbyError("");
          showJoinStatus(`Beitritt f√ºr ${code} angefragt‚Ä¶`);
          joinPending = { code };
          socket.emit("request_join", { name, code });
        };
      });
    }

    function getRoundBestPlayerIndex(round) {
      const entries = round
        .map((entry, i) => ({ ...entry, index: i }))
        .filter(e => e && e.label && typeof e.tier !== "undefined");
      if (!entries.length) return null;
      entries.sort((a, b) => {
        if (a.tier !== b.tier) return b.tier - a.tier;
        if (a.subvalue !== b.subvalue) return b.subvalue - a.subvalue;
        if (a.throws !== b.throws) return a.throws - b.throws;
        return a.index - b.index;
      });
      return entries[0].index;
    }

    function updateHistoryTable() {
      if (!state || !state.history || !state.history.length) {
        document.getElementById("historyTable").innerHTML = "";
        return;
      }

      const players = state.players;
      const history = state.history;
      const useDeckel = !!state.useDeckel;
      const wins = state.wins || [];
      const deckelCount = state.deckelCount || [];

      let html = "<h3>Spielverlauf</h3><table>";
      html += "<tr><th rowspan='2'>Runde</th>";
      players.forEach((name, i) => {
        let displayName = useDeckel ? `${escapeHtml(name)} (${deckelCount[i] || 0})`
                                    : ((wins[i] > 0) ? `${escapeHtml(name)} (${wins[i]} üëë)` : escapeHtml(name));
        html += `<th colspan="2" style="color:${playerTextColors[i % playerTextColors.length]};">${displayName}</th>`;
      });
      html += "</tr>";

      html += "<tr>";
      players.forEach(() => {
        html += `<th>üé≤</th><th>${useDeckel ? "Deckel" : "üîÅ"}</th>`;
      });
      html += "</tr>";

      for (let i = history.length - 1; i >= 0; i--) {
        const r = history[i];
        const winnerIndex = getRoundBestPlayerIndex(r);

        html += `<tr><td>${i + 1}</td>`;
        players.forEach((_, p) => {
          const entry = r[p];
          const isWinner = p === winnerIndex && entry;
          const cls = isWinner ? "winner" : "";
          if (entry) {
            html += `<td class="${cls}">${escapeHtml(entry.label)}</td>`;
            html += `<td class="${cls}">${useDeckel ? (deckelCount[p] || 0) : entry.throws}</td>`;
          } else {
            html += `<td>-</td><td>-</td>`;
          }
        });
        html += "</tr>";
      }

      html += "</table>";
      document.getElementById("historyTable").innerHTML = html;
    }

    function renderGame() {
      if (!state) return;

      const currentName = state.players[state.currentPlayer] || "-";
      document.getElementById("playerDisplay").textContent = `Am Zug: ${currentName}`;
      document.getElementById("throwCount").textContent = `Wurf: ${state.throwCount}`;
      document.getElementById("roundDisplay").textContent = `Runde: ${state.roundNumber}`;

      const colorIdx = state.currentPlayer % playerTextColors.length;
      document.getElementById("playerDisplay").style.color = playerTextColors[colorIdx];
      document.body.style.backgroundColor = playerBgColors[colorIdx];

      for (let i = 0; i < 3; i++) {
        const el = document.getElementById(`die${i}`);
        const val = state.dice[i];
        el.textContent = val ? diceSymbols[val - 1] : "‚ñ°";
        el.className = "die" + (state.held[i] ? " held" : "");
        el.onclick = () => {
          if (!isMyTurn()) return;
          socket.emit("action_toggle", { code: room.code, index: i });
        };
      }

      const remaining = state.maxThrowsThisRound - state.throwCount;
      const allHeld = state.held.every(h => h);

      const rollBtn = document.getElementById("rollBtn");
      rollBtn.textContent = allHeld ? "Alle W√ºrfel gehalten" : `W√ºrfeln (${remaining})`;
      rollBtn.disabled = !isMyTurn() || allHeld || remaining <= 0;

      const endBtn = document.getElementById("endTurnBtn");
      endBtn.disabled = !isMyTurn() || state.throwCount === 0 || state.dice.includes(null) || state.convertedThisTurn;

      document.getElementById("turnHint").textContent =
        isMyTurn() ? "Du bist am Zug." : "Du bist gerade nicht am Zug (Zuschauer-Modus).";

      document.getElementById("btnRotatePlayer").style.display = isHost ? "inline-flex" : "none";

      const myTurnNow = isMyTurn();
      if (myTurnNow && !wasMyTurn) {
        notifyMyTurn(currentName);
      }
      wasMyTurn = myTurnNow;

      if (state.message) showGameMessage(state.message, false);

      updateHistoryTable();
    }

    // Keepalive: solange die Seite ge√∂ffnet ist (bis zu 72h)
    let pingTimer = null;
    let pingStopTimer = null;
    const KEEPALIVE_DURATION_MS = 72 * 60 * 60 * 1000;
    function startKeepalive() {
      if (pingTimer) return;
      pingTimer = setInterval(() => {
        fetch("/ping", { cache: "no-store" }).catch(() => {});
      }, 5 * 60 * 1000);
      if (!pingStopTimer) {
        pingStopTimer = setTimeout(() => {
          stopKeepalive();
        }, KEEPALIVE_DURATION_MS);
      }
    }
    function stopKeepalive() {
      if (!pingTimer) return;
      clearInterval(pingTimer);
      pingTimer = null;
      if (pingStopTimer) {
        clearTimeout(pingStopTimer);
        pingStopTimer = null;
      }
    }

    // ---- Socket events ----
    socket.on("room_joined", (payload) => {
      showLobbyError("");
      showJoinStatus("");
      joinPending = null;

      myRoomCode = payload.code;
      myToken = payload.token;
      mySeat = payload.seatIndex;
      myName = payload.name;
      isHost = payload.isHost;

      localStorage.setItem("schocken_code", myRoomCode);
      localStorage.setItem("schocken_token", myToken);
      localStorage.setItem("schocken_seat", String(mySeat));
      localStorage.setItem("schocken_name", myName);

      room = payload.room;
      state = payload.state || null;

      renderRoomView();

      if (state) {
        setView("game");
        startKeepalive();
        renderGame();
      } else {
        setView("lobby");
      }
    });

    socket.on("room_update", (payloadRoom) => {
      room = payloadRoom;
      renderRoomView();
    });

    socket.on("lobby_list", (payload) => {
      renderLobbyList(payload.lobbies || []);
    });

    socket.on("join_pending", ({ code }) => {
      joinPending = { code };
      showJoinStatus(`Warte auf Best√§tigung durch den Host (${code}).`);
    });

    socket.on("join_denied", ({ message }) => {
      joinPending = null;
      showJoinStatus("");
      showLobbyError(message || "Beitritt abgelehnt.");
    });

    socket.on("join_requests_update", ({ requests }) => {
      renderPendingList(requests);
    });

    socket.on("join_request_notice", ({ name, code }) => {
      notifyJoinRequest(name, code);
    });

    socket.on("state_update", (payloadState) => {
      state = payloadState;
      setView("game");
      startKeepalive();
      renderGame();
    });

    socket.on("error_msg", ({ message }) => {
      const hadJoinPending = !!joinPending;
      showJoinStatus("");
      joinPending = null;
      if (message === "Room-Code nicht gefunden.") {
        socket.emit("get_lobby_list");
      }
      if (message === "Room-Code nicht gefunden." && myRoomCode && myToken) {
        localStorage.removeItem("schocken_code");
        localStorage.removeItem("schocken_token");
        localStorage.removeItem("schocken_seat");
        myRoomCode = null; myToken = null; mySeat = -1;
        document.getElementById("rejoinBox").style.display = "none";
      }
      if (document.getElementById("lobby").style.display !== "none") {
        if (message === "Room-Code nicht gefunden." && hadJoinPending) {
          showLobbyError("Lobby existiert nicht mehr.");
        } else {
          showLobbyError(message);
        }
      }
      else showGameMessage(message, true);
    });

    socket.on("lobby_returned", ({ message } = {}) => {
      setView("lobby");
      document.body.style.backgroundColor = "";
      wasMyTurn = false;
      showLobbyError(message || "");
    });

    // ---- Buttons ----
    document.getElementById("btnCreate").onclick = () => {
      const name = document.getElementById("hostName").value.trim();
      const useDeckel = document.getElementById("deckelToggle").checked;
      const requestedCode = document.getElementById("hostCode").value.trim().toUpperCase();
      if (!name) return showLobbyError("Bitte Name eingeben.");
      socket.emit("create_room", { name, useDeckel, requestedCode });
    };

    document.getElementById("btnJoin").onclick = () => {
      const name = document.getElementById("joinName").value.trim();
      const code = document.getElementById("joinCode").value.trim().toUpperCase();
      if (!name) return showLobbyError("Bitte Name eingeben.");
      if (!code) return showLobbyError("Bitte Room-Code eingeben.");
      showLobbyError("");
      showJoinStatus(`Beitritt f√ºr ${code} angefragt‚Ä¶`);
      joinPending = { code };
      socket.emit("request_join", { name, code });
    };

    document.getElementById("btnStartGame").onclick = () => {
      if (!room || !myToken) return;
      socket.emit("start_game", { code: room.code, token: myToken });
    };

    document.getElementById("rollBtn").onclick = () => {
      if (!room) return;
      socket.emit("action_roll", { code: room.code });
    };

    document.getElementById("endTurnBtn").onclick = () => {
      if (!room) return;
      socket.emit("action_end_turn", { code: room.code });
    };

    document.getElementById("btnBackToLobby").onclick = () => {
      if (isHost && room && myToken) {
        socket.emit("return_lobby", { code: room.code, token: myToken });
        return;
      }
      showLobbyError("Nur der Host kann alle zur√ºck in die Lobby schicken.");
    };

    document.getElementById("btnRejoin").onclick = () => {
      if (!myRoomCode || !myToken) return;
      socket.emit("rejoin_room", { code: myRoomCode, token: myToken });
    };

    document.getElementById("btnForget").onclick = () => {
      localStorage.removeItem("schocken_code");
      localStorage.removeItem("schocken_token");
      localStorage.removeItem("schocken_seat");
      myRoomCode = null; myToken = null; mySeat = -1;
      document.getElementById("rejoinBox").style.display = "none";
      showLobbyError("Vergessen. Du kannst neu erstellen oder beitreten.");
    };

    document.getElementById("btnNewCode").onclick = () => {
      setSuggestedCode();
    };

    window.onload = () => {
      setSuggestedCode();
      if (myRoomCode && myToken) {
        document.getElementById("rejoinBox").style.display = "block";
      }
      showJoinStatus("");
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js").catch(() => {});
      }
      startKeepalive();
    };

    document.getElementById("btnReload").onclick = () => {
      window.location.reload();
    };

    socket.on("connect", () => {
      if (myRoomCode && myToken) {
        socket.emit("rejoin_room", { code: myRoomCode, token: myToken });
      }
      socket.emit("get_lobby_list");
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        if (myRoomCode && myToken) {
          socket.emit("rejoin_room", { code: myRoomCode, token: myToken });
        }
        socket.emit("get_lobby_list");
      }
    });
  </script>
</body>
</html>
